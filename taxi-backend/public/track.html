<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Seguir Viaje - Squid App</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      text-align: center;
    }
    .header h1 { font-size: 18px; margin-bottom: 5px; }
    .header p { font-size: 12px; opacity: 0.9; }
    
    #map { width: 100%; height: 50vh; }
    
    .info-card {
      background: white;
      margin: 15px;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .info-row {
      display: flex;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }
    .info-row:last-child { border-bottom: none; }
    .info-icon { font-size: 20px; margin-right: 12px; }
    .info-label { color: #666; font-size: 12px; }
    .info-value { font-weight: 600; color: #333; }
    
    .status-badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .status-active { background: #d4edda; color: #155724; }
    .status-completed { background: #cce5ff; color: #004085; }
    
    .update-time {
      text-align: center;
      padding: 10px;
      color: #666;
      font-size: 12px;
    }
    
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: #f5f5f5;
    }
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #ddd;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .error-container {
      text-align: center;
      padding: 50px 20px;
    }
    .error-icon { font-size: 60px; margin-bottom: 20px; }
  </style>
</head>
<body>
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p style="margin-top: 20px; color: #666;">Cargando ubicaci贸n...</p>
  </div>

  <div id="content" style="display: none;">
    <div class="header">
      <h1> Seguimiento de Viaje</h1>
      <p id="tripStatus">Viaje en progreso</p>
    </div>

    <div id="map"></div>

    <div class="info-card">
      <div class="info-row">
        <span class="info-icon"></span>
        <div>
          <div class="info-label">Destino</div>
          <div class="info-value" id="destination">-</div>
        </div>
      </div>
      <div class="info-row">
        <span class="info-icon"></span>
        <div>
          <div class="info-label">Conductor</div>
          <div class="info-value" id="driverName">-</div>
        </div>
      </div>
      <div class="info-row">
        <span class="info-icon"></span>
        <div>
          <div class="info-label">Placa</div>
          <div class="info-value" id="vehiclePlate">-</div>
        </div>
      </div>
      <div class="info-row">
        <span class="info-icon"></span>
        <div>
          <div class="info-label">Estado</div>
          <div><span class="status-badge status-active" id="statusBadge">En viaje</span></div>
        </div>
      </div>
    </div>

    <div class="update-time">
      ltima actualizaci贸n: <span id="lastUpdate">-</span>
    </div>
  </div>

  <div id="error" class="error-container" style="display: none;">
    <div class="error-icon"></div>
    <h2>Viaje no encontrado</h2>
    <p style="color: #666; margin-top: 10px;">Este enlace puede haber expirado o el viaje ya termin贸.</p>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let map, marker;
    const shareId = window.location.pathname.split('/').pop();
    let driverId = null;
    
    // Icono personalizado para el marcador
    const carIcon = L.divIcon({
      html: '<div style="font-size: 30px;"></div>',
      iconSize: [30, 30],
      iconAnchor: [15, 15],
      className: 'car-marker'
    });

    // Obtener datos iniciales del tracking
    async function initTracking() {
      try {
        const response = await fetch(`/api/tracking/${shareId}`);
        const data = await response.json();

        if (!data.success) {
          showError();
          return;
        }

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';

        const { tripData, status } = data;
        driverId = data.driverId || tripData?.driverId;

        // Actualizar info
        document.getElementById('destination').textContent = tripData.destination || 'No especificado';
        document.getElementById('driverName').textContent = tripData.driverName || 'No especificado';
        document.getElementById('vehiclePlate').textContent = tripData.vehiclePlate || 'No especificado';

        if (status === 'completed') {
          const statusBadge = document.getElementById('statusBadge');
          statusBadge.textContent = 'Viaje completado';
          statusBadge.className = 'status-badge status-completed';
          document.getElementById('tripStatus').textContent = 'Viaje finalizado';
          return;
        }

        // Iniciar tracking del conductor
        fetchDriverLocation();
        
      } catch (error) {
        console.error('Error:', error);
        showError();
      }
    }

    // Obtener ubicaci贸n del conductor en tiempo real
    async function fetchDriverLocation() {
      try {
        if (!driverId) {
          console.log('No hay driverId, usando tracking normal');
          fetchTrackingLocation();
          return;
        }

        const response = await fetch(`/api/drivers/${driverId}/location`);
        const data = await response.json();

        if (data.success && data.latitude && data.longitude) {
          updateMap(parseFloat(data.latitude), parseFloat(data.longitude));
          document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('es-DO');
        }

        // Seguir actualizando cada 3 segundos
        setTimeout(fetchDriverLocation, 3000);

      } catch (error) {
        console.error('Error obteniendo ubicaci贸n del conductor:', error);
        setTimeout(fetchDriverLocation, 5000);
      }
    }

    // Fallback: usar ubicaci贸n del tracking
    async function fetchTrackingLocation() {
      try {
        const response = await fetch(`/api/tracking/${shareId}`);
        const data = await response.json();

        if (data.success && data.currentLocation) {
          const { latitude, longitude } = data.currentLocation;
          updateMap(latitude, longitude);
          document.getElementById('lastUpdate').textContent = new Date(data.lastUpdate).toLocaleTimeString('es-DO');
        }

        if (data.status === 'active') {
          setTimeout(fetchTrackingLocation, 5000);
        }

      } catch (error) {
        console.error('Error:', error);
        setTimeout(fetchTrackingLocation, 5000);
      }
    }

    // Actualizar mapa con nueva ubicaci贸n
    function updateMap(latitude, longitude) {
      if (!map) {
        map = L.map('map').setView([latitude, longitude], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '漏 OpenStreetMap'
        }).addTo(map);
        marker = L.marker([latitude, longitude], { icon: carIcon }).addTo(map);
      } else {
        marker.setLatLng([latitude, longitude]);
        map.panTo([latitude, longitude]);
      }
    }

    function showError() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'block';
    }

    // Iniciar
    initTracking();
  </script>
</body>
</html>