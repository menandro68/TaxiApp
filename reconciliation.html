<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conciliaci√≥n de Pagos - TaxiApp</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .date-selector {
            display: flex;
            gap: 15px;
            align-items: center;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 10px;
        }

        .date-selector input {
            padding: 8px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .card-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-value {
            font-size: 28px;
            font-weight: bold;
            color: #333;
        }

        .card-subtitle {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .card.success { border-left: 4px solid #28a745; }
        .card.warning { border-left: 4px solid #ffc107; }
        .card.danger { border-left: 4px solid #dc3545; }
        .card.info { border-left: 4px solid #17a2b8; }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            padding: 0 30px;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #666;
            transition: all 0.3s;
            position: relative;
        }

        .tab.active {
            color: #667eea;
            font-weight: 600;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #667eea;
        }

        .tab-content {
            padding: 30px;
            min-height: 400px;
        }

        .section-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-size: 14px;
            color: #666;
            border-bottom: 2px solid #e9ecef;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-matched { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-error { background: #f8d7da; color: #721c24; }

        .actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .upload-section {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
        }

        .upload-icon {
            font-size: 48px;
            color: #dee2e6;
            margin-bottom: 20px;
        }

        .discrepancy-item {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <i class="fas fa-balance-scale"></i>
                Conciliaci√≥n de Pagos
            </h1>
            <div class="date-selector">
                <label>Fecha:</label>
                <input type="date" id="reconciliation-date" value="">
                <button class="btn btn-primary" onclick="loadReconciliation()">
                    <i class="fas fa-sync"></i> Cargar
                </button>
            </div>
        </div>

        <div class="summary-cards">
            <div class="card success">
                <div class="card-title">
                    <i class="fas fa-check-circle"></i> Conciliados
                </div>
                <div class="card-value" id="matched-amount">RD$0</div>
                <div class="card-subtitle"><span id="matched-count">0</span> transacciones</div>
            </div>
            <div class="card warning">
                <div class="card-title">
                    <i class="fas fa-clock"></i> Pendientes
                </div>
                <div class="card-value" id="pending-amount">RD$0</div>
                <div class="card-subtitle"><span id="pending-count">0</span> por verificar</div>
            </div>
            <div class="card danger">
                <div class="card-title">
                    <i class="fas fa-exclamation-triangle"></i> Discrepancias
                </div>
                <div class="card-value" id="discrepancy-amount">RD$0</div>
                <div class="card-subtitle"><span id="discrepancy-count">0</span> diferencias</div>
            </div>
            <div class="card info">
                <div class="card-title">
                    <i class="fas fa-percentage"></i> Precisi√≥n
                </div>
                <div class="card-value" id="accuracy-rate">0%</div>
                <div class="card-subtitle">Tasa de conciliaci√≥n</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('transactions')">
                <i class="fas fa-list"></i> Transacciones
            </button>
            <button class="tab" onclick="switchTab('import')">
                <i class="fas fa-upload"></i> Importar Datos
            </button>
            <button class="tab" onclick="switchTab('discrepancies')">
                <i class="fas fa-exclamation"></i> Discrepancias
            </button>
            <button class="tab" onclick="switchTab('report')">
                <i class="fas fa-file-alt"></i> Reporte
            </button>
        </div>

        <div class="tab-content">
            <div id="transactions-tab">
                <!-- Se llenar√° din√°micamente -->
            </div>
            <div id="import-tab" style="display:none;">
                <!-- Se llenar√° din√°micamente -->
            </div>
            <div id="discrepancies-tab" style="display:none;">
                <!-- Se llenar√° din√°micamente -->
            </div>
            <div id="report-tab" style="display:none;">
                <!-- Se llenar√° din√°micamente -->
            </div>
        </div>
    </div>

    <script>
        // Estado global
        let currentTransactions = [];
        let bankTransactions = [];
        let discrepancies = [];

        // Inicializar fecha con hoy
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reconciliation-date').value = today;
            loadReconciliation();
        });

        // Cargar datos de conciliaci√≥n
        function loadReconciliation() {
            const date = document.getElementById('reconciliation-date').value;
            console.log('Cargando conciliaci√≥n para:', date);
            
            // Simular carga de datos
            generateSampleData();
            updateSummary();
            displayTransactions();
        }

        // Generar datos de ejemplo
        function generateSampleData() {
            // Transacciones del sistema
            currentTransactions = [
                { id: 'TRX001', time: '08:15', driver: 'Juan P√©rez', passenger: 'Mar√≠a Garc√≠a', amount: 450, method: 'Efectivo', status: 'matched', bankRef: 'BNK001' },
                { id: 'TRX002', time: '09:30', driver: 'Carlos L√≥pez', passenger: 'Ana Mart√≠nez', amount: 680, method: 'Tarjeta', status: 'matched', bankRef: 'BNK002' },
                { id: 'TRX003', time: '10:45', driver: 'Pedro S√°nchez', passenger: 'Luis Rodr√≠guez', amount: 320, method: 'Efectivo', status: 'pending', bankRef: null },
                { id: 'TRX004', time: '11:20', driver: 'Mar√≠a Torres', passenger: 'Jos√© D√≠az', amount: 550, method: 'Digital', status: 'matched', bankRef: 'BNK003' },
                { id: 'TRX005', time: '12:00', driver: 'Roberto Silva', passenger: 'Carmen Ruiz', amount: 890, method: 'Tarjeta', status: 'error', bankRef: 'BNK004', discrepancy: 40 },
                { id: 'TRX006', time: '14:15', driver: 'Ana Jim√©nez', passenger: 'Miguel √Ångel', amount: 420, method: 'Efectivo', status: 'pending', bankRef: null },
                { id: 'TRX007', time: '15:30', driver: 'Diego Moreno', passenger: 'Isabel Castro', amount: 760, method: 'Digital', status: 'matched', bankRef: 'BNK005' },
                { id: 'TRX008', time: '16:45', driver: 'Laura Flores', passenger: 'Francisco Luna', amount: 510, method: 'Tarjeta', status: 'matched', bankRef: 'BNK006' }
            ];

            // Transacciones bancarias
            bankTransactions = [
                { ref: 'BNK001', amount: 450, status: 'matched' },
                { ref: 'BNK002', amount: 680, status: 'matched' },
                { ref: 'BNK003', amount: 550, status: 'matched' },
                { ref: 'BNK004', amount: 850, status: 'discrepancy' }, // Diferencia con TRX005
                { ref: 'BNK005', amount: 760, status: 'matched' },
                { ref: 'BNK006', amount: 510, status: 'matched' },
                { ref: 'BNK007', amount: 300, status: 'unmatched' } // Sin match en sistema
            ];

            // Generar discrepancias
            discrepancies = [
                { 
                    type: 'amount_mismatch',
                    transaction: 'TRX005',
                    expected: 890,
                    actual: 850,
                    difference: -40,
                    description: 'Diferencia en monto cobrado'
                },
                {
                    type: 'unmatched_bank',
                    reference: 'BNK007',
                    amount: 300,
                    description: 'Pago en banco sin registro en sistema'
                },
                {
                    type: 'pending_cash',
                    transactions: ['TRX003', 'TRX006'],
                    totalAmount: 740,
                    description: 'Efectivo pendiente de dep√≥sito'
                }
            ];
        }

        // Actualizar resumen
        function updateSummary() {
            const matched = currentTransactions.filter(t => t.status === 'matched');
            const pending = currentTransactions.filter(t => t.status === 'pending');
            const errors = currentTransactions.filter(t => t.status === 'error');
            
            const matchedAmount = matched.reduce((sum, t) => sum + t.amount, 0);
            const pendingAmount = pending.reduce((sum, t) => sum + t.amount, 0);
            const errorAmount = errors.reduce((sum, t) => sum + t.amount, 0);
            
            document.getElementById('matched-amount').textContent = `RD$${matchedAmount.toLocaleString()}`;
            document.getElementById('matched-count').textContent = matched.length;
            
            document.getElementById('pending-amount').textContent = `RD$${pendingAmount.toLocaleString()}`;
            document.getElementById('pending-count').textContent = pending.length;
            
            document.getElementById('discrepancy-amount').textContent = `RD$${errorAmount.toLocaleString()}`;
            document.getElementById('discrepancy-count').textContent = discrepancies.length;
            
            const accuracy = matched.length / currentTransactions.length * 100;
            document.getElementById('accuracy-rate').textContent = `${accuracy.toFixed(1)}%`;
        }

        // Cambiar pesta√±as
        function switchTab(tabName) {
            // Actualizar botones de pesta√±as
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Ocultar todos los contenidos
            document.querySelectorAll('[id$="-tab"]').forEach(content => {
                content.style.display = 'none';
            });
            
            // Mostrar contenido seleccionado
            const selectedTab = document.getElementById(`${tabName}-tab`);
            if (selectedTab) {
                selectedTab.style.display = 'block';
                
                // Cargar contenido seg√∫n la pesta√±a
                switch(tabName) {
                    case 'transactions':
                        displayTransactions();
                        break;
                    case 'import':
                        displayImportSection();
                        break;
                    case 'discrepancies':
                        displayDiscrepancies();
                        break;
                    case 'report':
                        displayReport();
                        break;
                }
            }
        }

        // Mostrar transacciones
        function displayTransactions() {
            const container = document.getElementById('transactions-tab');
            
            let html = `
                <div class="section-title">
                    <span>Transacciones del D√≠a</span>
                    <button class="btn btn-success" onclick="reconcileAll()">
                        <i class="fas fa-check-double"></i> Conciliar Todo
                    </button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Hora</th>
                            <th>Conductor</th>
                            <th>Pasajero</th>
                            <th>Monto</th>
                            <th>M√©todo</th>
                            <th>Estado</th>
                            <th>Ref. Bancaria</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            currentTransactions.forEach(trans => {
                const statusClass = trans.status === 'matched' ? 'status-matched' : 
                                   trans.status === 'pending' ? 'status-pending' : 'status-error';
                
                html += `
                    <tr>
                        <td><strong>${trans.id}</strong></td>
                        <td>${trans.time}</td>
                        <td>${trans.driver}</td>
                        <td>${trans.passenger}</td>
                        <td><strong>RD$${trans.amount}</strong></td>
                        <td>${trans.method}</td>
                        <td><span class="status-badge ${statusClass}">${
                            trans.status === 'matched' ? 'Conciliado' :
                            trans.status === 'pending' ? 'Pendiente' : 'Error'
                        }</span></td>
                        <td>${trans.bankRef || '-'}</td>
                        <td>
                            <div class="actions">
                                ${trans.status === 'pending' ? 
                                    `<button class="btn btn-success" onclick="matchTransaction('${trans.id}')">
                                        <i class="fas fa-check"></i>
                                    </button>` : ''}
                                ${trans.status === 'error' ? 
                                    `<button class="btn btn-warning" onclick="resolveDiscrepancy('${trans.id}')">
                                        <i class="fas fa-wrench"></i>
                                    </button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Mostrar secci√≥n de importaci√≥n
        function displayImportSection() {
            const container = document.getElementById('import-tab');
            
            container.innerHTML = `
                <div class="section-title">Importar Datos Bancarios</div>
                
                <div class="upload-section">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h3>Arrastra tu archivo aqu√≠</h3>
                    <p>O haz clic para seleccionar</p>
                    <input type="file" id="file-input" accept=".csv,.xls,.xlsx" style="display:none;">
                    <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">
                        Seleccionar Archivo
                    </button>
                    <p style="margin-top: 15px; color: #666;">
                        Formatos soportados: CSV, Excel
                    </p>
                </div>
                
                <div class="section-title">Conexi√≥n Bancaria Autom√°tica</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <button class="btn" style="padding: 20px; background: #007bff; color: white;">
                        <i class="fas fa-university"></i> Banco Popular
                    </button>
                    <button class="btn" style="padding: 20px; background: #28a745; color: white;">
                        <i class="fas fa-university"></i> Banco BHD
                    </button>
                    <button class="btn" style="padding: 20px; background: #dc3545; color: white;">
                        <i class="fas fa-university"></i> Scotiabank
                    </button>
                    <button class="btn" style="padding: 20px; background: #ffc107; color: #333;">
                        <i class="fas fa-university"></i> Banreservas
                    </button>
                </div>
            `;
        }

        // Mostrar discrepancias
        function displayDiscrepancies() {
            const container = document.getElementById('discrepancies-tab');
            
            let html = `
                <div class="section-title">
                    <span>Discrepancias Detectadas</span>
                    <span style="color: #dc3545;">${discrepancies.length} items por resolver</span>
                </div>
            `;
            
            discrepancies.forEach((disc, index) => {
                html += `
                    <div class="discrepancy-item">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h4 style="margin-bottom: 10px;">
                                    ${disc.type === 'amount_mismatch' ? 'üí∞ Diferencia de Monto' :
                                      disc.type === 'unmatched_bank' ? 'üè¶ Pago sin Registro' :
                                      'üíµ Efectivo Pendiente'}
                                </h4>
                                <p>${disc.description}</p>
                                ${disc.type === 'amount_mismatch' ? 
                                    `<p>Transacci√≥n: <strong>${disc.transaction}</strong></p>
                                     <p>Sistema: <strong>RD$${disc.expected}</strong> | 
                                        Banco: <strong>RD$${disc.actual}</strong> | 
                                        Diferencia: <strong style="color: #dc3545;">RD$${disc.difference}</strong></p>` :
                                  disc.type === 'unmatched_bank' ?
                                    `<p>Referencia: <strong>${disc.reference}</strong></p>
                                     <p>Monto: <strong>RD$${disc.amount}</strong></p>` :
                                    `<p>Transacciones: <strong>${disc.transactions.join(', ')}</strong></p>
                                     <p>Total: <strong>RD$${disc.totalAmount}</strong></p>`
                                }
                            </div>
                            <div class="actions">
                                <button class="btn btn-success" onclick="resolveItem(${index})">
                                    Resolver
                                </button>
                                <button class="btn btn-warning" onclick="investigateItem(${index})">
                                    Investigar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Mostrar reporte
        function displayReport() {
            const container = document.getElementById('report-tab');
            const date = document.getElementById('reconciliation-date').value;
            
            const totalSystem = currentTransactions.reduce((sum, t) => sum + t.amount, 0);
            const totalBank = bankTransactions.reduce((sum, t) => sum + t.amount, 0);
            const difference = totalBank - totalSystem;
            
            container.innerHTML = `
                <div class="section-title">
                    <span>Reporte de Conciliaci√≥n - ${date}</span>
                    <div>
                        <button class="btn btn-primary" onclick="exportPDF()">
                            <i class="fas fa-file-pdf"></i> Exportar PDF
                        </button>
                        <button class="btn btn-success" onclick="exportExcel()">
                            <i class="fas fa-file-excel"></i> Exportar Excel
                        </button>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3>Resumen Ejecutivo</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px;">
                        <div>
                            <label style="color: #666;">Total Sistema:</label>
                            <div style="font-size: 24px; font-weight: bold;">RD$${totalSystem.toLocaleString()}</div>
                        </div>
                        <div>
                            <label style="color: #666;">Total Banco:</label>
                            <div style="font-size: 24px; font-weight: bold;">RD$${totalBank.toLocaleString()}</div>
                        </div>
                        <div>
                            <label style="color: #666;">Diferencia:</label>
                            <div style="font-size: 24px; font-weight: bold; color: ${difference === 0 ? '#28a745' : '#dc3545'};">
                                RD$${Math.abs(difference).toLocaleString()}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 75%;">
                        75% Conciliado
                    </div>
                </div>
                
                <h4>Estado de Cierre</h4>
                <table style="margin-top: 20px;">
                    <tr>
                        <td>Hora de Inicio:</td>
                        <td><strong>06:00 AM</strong></td>
                    </tr>
                    <tr>
                        <td>Hora de Cierre:</td>
                        <td><strong>11:59 PM</strong></td>
                    </tr>
                    <tr>
                        <td>Total de Transacciones:</td>
                        <td><strong>${currentTransactions.length}</strong></td>
                    </tr>
                    <tr>
                        <td>Transacciones Conciliadas:</td>
                        <td><strong>${currentTransactions.filter(t => t.status === 'matched').length}</strong></td>
                    </tr>
                    <tr>
                        <td>Pendientes de Conciliar:</td>
                        <td><strong>${currentTransactions.filter(t => t.status === 'pending').length}</strong></td>
                    </tr>
                    <tr>
                        <td>Con Discrepancias:</td>
                        <td><strong>${currentTransactions.filter(t => t.status === 'error').length}</strong></td>
                    </tr>
                </table>
                
                <div style="margin-top: 30px; text-align: center;">
                    <button class="btn btn-success" style="font-size: 18px; padding: 15px 40px;" onclick="closeDay()">
                        <i class="fas fa-lock"></i> Cerrar D√≠a
                    </button>
                </div>
            `;
        }

        // Funciones de acci√≥n
        function reconcileAll() {
            if (confirm('¬øDesea conciliar todas las transacciones pendientes?')) {
                currentTransactions.forEach(trans => {
                    if (trans.status === 'pending') {
                        trans.status = 'matched';
                        trans.bankRef = 'AUTO-' + Date.now();
                    }
                });
                loadReconciliation();
                alert('‚úÖ Todas las transacciones han sido conciliadas');
            }
        }

        function matchTransaction(id) {
            const trans = currentTransactions.find(t => t.id === id);
            if (trans) {
                trans.status = 'matched';
                trans.bankRef = 'MAN-' + Date.now();
                loadReconciliation();
            }
        }

        function resolveDiscrepancy(id) {
            const trans = currentTransactions.find(t => t.id === id);
            if (trans) {
                const action = prompt('Ingrese la acci√≥n tomada para resolver esta discrepancia:');
                if (action) {
                    trans.status = 'matched';
                    trans.note = action;
                    loadReconciliation();
                    alert('‚úÖ Discrepancia resuelta');
                }
            }
        }

        function resolveItem(index) {
            const disc = discrepancies[index];
            const resolution = prompt('Describa la resoluci√≥n:');
            if (resolution) {
                discrepancies.splice(index, 1);
                loadReconciliation();
                alert('‚úÖ Item resuelto: ' + resolution);
            }
        }

        function investigateItem(index) {
            alert('üìã Se ha creado un ticket de investigaci√≥n para este item');
        }

        function exportPDF() {
            alert('üìÑ Generando PDF del reporte...');
        }

        function exportExcel() {
            alert('üìä Generando Excel del reporte...');
        }

        function closeDay() {
            if (confirm('‚ö†Ô∏è ¬øEst√° seguro de cerrar el d√≠a?\n\nEsta acci√≥n no se puede deshacer.')) {
                alert('‚úÖ D√≠a cerrado exitosamente\n\nReporte enviado a contabilidad');
            }
        }
    </script>
</body>
</html>